{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">Caso práctico — Random Forest: Predicción de Rotación de Empleados</h2>
    <p class="lead">Predicción de probabilidad de renuncia utilizando Random Forest Classifier</p>
  </div>

  <!-- Columna izquierda: Métricas y descripción -->
  <div class="col-md-4">
    <!-- Card de Exactitud -->
    <div class="card text-center mb-3 border-primary">
      <div class="card-body">
        <h5 class="card-title text-primary">Exactitud (Test)</h5>
        {% if metrics and metrics.accuracy %}
        <p class="display-4 fw-bold text-success">{{ "%.4f"|format(metrics.accuracy) }}</p>
        {% else %}
        <p class="display-4 fw-bold text-muted">N/A</p>
        <p class="text-danger small">Modelo no entrenado</p>
        {% endif %}
        
        {% if metrics and metrics.roc_auc %}
        <hr>
        <p class="mb-0"><strong>ROC-AUC:</strong> <span class="badge bg-info">{{ "%.4f"|format(metrics.roc_auc) }}</span></p>
        {% endif %}
      </div>
    </div>

    <!-- Card de Descripción del Dataset -->
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Descripción del Dataset</h5>
      </div>
      <div class="card-body">
        <p><strong>Objetivo:</strong> Predecir rotación de empleados</p>
        <p><strong>Clase Positiva:</strong> Alta (renuncia probable)</p>
        <hr>
        <h6>Variables Independientes:</h6>
        <ul class="list-unstyled">
          <li><strong>anios_empresa:</strong> Años en la compañía (numérico, escalado)</li>
          <li><strong>nivel_satisfaccion:</strong> Satisfacción laboral 0-1 (numérico, escalado)</li>
          <li><strong>salario:</strong> Salario actual (numérico, escalado)</li>
          <li><strong>n_capacitaciones:</strong> Número de capacitaciones (entero, escalado)</li>
          <li><strong>eval_desempeno:</strong> Evaluación 1-5 (numérico, escalado)</li>
        </ul>
        <hr>
        <p class="mb-0 small text-muted"><strong>Preprocesamiento:</strong> Imputación de valores faltantes (mediana) y escalado estándar en pipeline.</p>
      </div>
    </div>

    <!-- Card de Matriz de Confusión -->
    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Matriz de Confusión</h5>
      </div>
      <div class="card-body text-center">
        {% if cm_img %}
          <img src="{{ url_for('static', filename=cm_img) }}" alt="Matriz de confusión" class="img-fluid rounded border" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\'%3E%3Crect fill=\'%23f0f0f0\' width=\'300\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'sans-serif\' font-size=\'14\' fill=\'%23666\'%3EImagen no disponible%3C/text%3E%3C/svg%3E';">
        {% else %}
          <div class="alert alert-warning">
            <p class="mb-0">Matriz de confusión no disponible. Entrena el modelo primero.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Columna derecha: Reporte y Formulario -->
  <div class="col-md-8">
    <!-- Card de Reporte de Clasificación -->
    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Reporte de Clasificación</h5>
      </div>
      <div class="card-body">
        {% if report and report.keys()|length > 0 %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Clase</th>
                  <th>Precision</th>
                  <th>Recall</th>
                  <th>F1-score</th>
                  <th>Support</th>
                </tr>
              </thead>
              <tbody>
                {% for cls in ['Baja', 'Alta'] %}
                  {% if cls in report %}
                  <tr>
                    <td><strong>{{ cls }}</strong></td>
                    <td>{{ "%.4f"|format(report[cls].precision) }}</td>
                    <td>{{ "%.4f"|format(report[cls].recall) }}</td>
                    <td>{{ "%.4f"|format(report[cls]['f1-score']) }}</td>
                    <td>{{ report[cls].support }}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if 'accuracy' in report %}
          <div class="mt-2">
            <p class="mb-1"><strong>Accuracy general:</strong> {{ "%.4f"|format(report.accuracy) }}</p>
            {% if 'macro avg' in report %}
            <p class="mb-1"><strong>Macro avg F1:</strong> {{ "%.4f"|format(report['macro avg']['f1-score']) }}</p>
            {% endif %}
            {% if 'weighted avg' in report %}
            <p class="mb-0"><strong>Weighted avg F1:</strong> {{ "%.4f"|format(report['weighted avg']['f1-score']) }}</p>
            {% endif %}
          </div>
          {% endif %}
        {% else %}
          <div class="alert alert-warning">
            <p class="mb-0">Reporte no disponible. Entrena el modelo primero.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Card de Formulario de Predicción -->
    <div class="card mb-3 border-warning">
      <div class="card-header bg-warning">
        <h5 class="mb-0">Formulario de Predicción</h5>
      </div>
      <div class="card-body">
        <form id="predict-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Años en la empresa</label>
              <input type="number" step="0.1" min="0" max="40" class="form-control" name="anios_empresa" placeholder="Ej: 3.5" required>
              <small class="text-muted">Rango: 0 - 40 años</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Nivel de satisfacción</label>
              <input type="number" step="0.01" min="0" max="1" class="form-control" name="nivel_satisfaccion" placeholder="Ej: 0.75" required>
              <small class="text-muted">Rango: 0.00 - 1.00</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Salario</label>
              <input type="number" step="0.01" min="0" class="form-control" name="salario" placeholder="Ej: 3500" required>
              <small class="text-muted">En unidades locales</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Número de capacitaciones</label>
              <input type="number" step="1" min="0" class="form-control" name="n_capacitaciones" placeholder="Ej: 2" required>
              <small class="text-muted">Entero positivo</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Evaluación de desempeño</label>
              <input type="number" step="0.1" min="1" max="5" class="form-control" name="eval_desempeno" placeholder="Ej: 3.8" required>
              <small class="text-muted">Escala: 1 - 5</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Umbral (threshold)</label>
              <input type="number" step="0.01" min="0" max="1" value="0.5" class="form-control" name="threshold">
              <small class="text-muted">Por defecto: 0.5</small>
            </div>
          </div>
          
          <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg w-100">
              <span id="btn-text">Predecir Rotación</span>
              <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>

        <!-- Resultado de la Predicción -->
        <div class="mt-4" id="predict-result" style="display:none;">
          <div class="alert border-3" role="alert">
            <h4 class="alert-heading" id="pred-text"></h4>
            <hr>
            <p class="mb-2" id="pred-prob"></p>
            <p class="mb-0 small" id="pred-interpret"></p>
          </div>
        </div>

        <!-- Mensaje de Error -->
        <div class="mt-3" id="error-message" style="display:none;">
          <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> <span id="error-text"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('predict-form').addEventListener('submit', async function(e){
  e.preventDefault();
  
  // Ocultar mensajes previos
  document.getElementById('predict-result').style.display = 'none';
  document.getElementById('error-message').style.display = 'none';
  
  // Mostrar spinner
  document.getElementById('btn-text').classList.add('d-none');
  document.getElementById('btn-spinner').classList.remove('d-none');
  
  const form = e.target;
  const data = {
    anios_empresa: parseFloat(form.anios_empresa.value),
    nivel_satisfaccion: parseFloat(form.nivel_satisfaccion.value),
    salario: parseFloat(form.salario.value),
    n_capacitaciones: parseInt(form.n_capacitaciones.value),
    eval_desempeno: parseFloat(form.eval_desempeno.value),
    threshold: parseFloat(form.threshold.value)
  };

  // Validaciones front básicas
  if (data.nivel_satisfaccion < 0 || data.nivel_satisfaccion > 1){
    showError("El nivel de satisfacción debe estar entre 0 y 1");
    resetButton();
    return;
  }
  
  if (data.eval_desempeno < 1 || data.eval_desempeno > 5){
    showError("La evaluación de desempeño debe estar entre 1 y 5");
    resetButton();
    return;
  }
  
  if (data.threshold < 0 || data.threshold > 1){
    showError("El threshold debe estar entre 0 y 1");
    resetButton();
    return;
  }

  try {
    const resp = await fetch("{{ url_for('clasificacion_predict') }}", {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const json = await resp.json();
    
    if (resp.ok){
      document.getElementById('predict-result').style.display = 'block';
      
      const label = json.label;
      const prob = json.probability;
      
      // Cambiar color según predicción
      const resultDiv = document.getElementById('predict-result').querySelector('.alert');
      if (label === 'Alta') {
        resultDiv.className = 'alert alert-danger border-3';
        document.getElementById('pred-text').innerHTML = '⚠️ Predicción: <strong>ROTACIÓN ALTA</strong>';
      } else {
        resultDiv.className = 'alert alert-success border-3';
        document.getElementById('pred-text').innerHTML = '✅ Predicción: <strong>ROTACIÓN BAJA</strong>';
      }
      
      document.getElementById('pred-prob').innerHTML = 
        `<strong>Probabilidad de rotación alta:</strong> ${(prob * 100).toFixed(2)}% (${prob.toFixed(4)})`;
      
      // Interpretación del threshold
      let interpretacion = `Con threshold = ${data.threshold.toFixed(2)}, `;
      if (data.threshold < 0.5) {
        interpretacion += "se prioriza <strong>recall</strong> (capturar más casos de rotación alta), aumentando falsos positivos.";
      } else if (data.threshold > 0.5) {
        interpretacion += "se prioriza <strong>precision</strong> (predicciones más confiables), pudiendo perder algunos casos de rotación.";
      } else {
        interpretacion += "se mantiene un <strong>balance</strong> entre precision y recall.";
      }
      
      document.getElementById('pred-interpret').innerHTML = interpretacion;
      
    } else {
      showError(json.error || "Error desconocido en la predicción");
    }
  } catch (error) {
    showError("Error de conexión: " + error.message);
  } finally {
    resetButton();
  }
});

function showError(message) {
  document.getElementById('error-text').textContent = message;
  document.getElementById('error-message').style.display = 'block';
}

function resetButton() {
  document.getElementById('btn-text').classList.remove('d-none');
  document.getElementById('btn-spinner').classList.add('d-none');
}
</script>

{% endblock %}