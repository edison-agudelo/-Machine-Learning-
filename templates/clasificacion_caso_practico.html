{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">Caso pr√°ctico ‚Äî Random Forest: Predicci√≥n de Rotaci√≥n de Empleados</h2>
    <p class="lead">Predicci√≥n de probabilidad de renuncia utilizando Random Forest Classifier</p>
  </div>

  <!-- Columna izquierda: M√©tricas y descripci√≥n -->
  <div class="col-md-4">
    <!-- Card de Exactitud -->
    <div class="card text-center mb-3 border-primary">
      <div class="card-body">
        <h5 class="card-title text-primary">Exactitud (Test)</h5>
        <p class="display-4 fw-bold text-success">{{ "%.4f"|format(metrics.accuracy) if metrics and metrics.accuracy else 'N/A' }}</p>
        {% if metrics and metrics.roc_auc %}
        <hr>
        <p class="mb-0"><strong>ROC-AUC:</strong> <span class="badge bg-info">{{ "%.4f"|format(metrics.roc_auc) }}</span></p>
        {% endif %}
      </div>
    </div>

    <!-- Card de Descripci√≥n del Dataset -->
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Descripci√≥n del Dataset</h5>
      </div>
      <div class="card-body">
        <p><strong>Objetivo:</strong> Predecir rotaci√≥n de empleados</p>
        <p><strong>Clase Positiva:</strong> Alta (renuncia probable)</p>
        <hr>
        <h6>Variables Independientes:</h6>
        <ul class="list-unstyled">
          <li>üìä <strong>anios_empresa:</strong> A√±os en la compa√±√≠a (num√©rico, escalado)</li>
          <li>üòä <strong>nivel_satisfaccion:</strong> Satisfacci√≥n laboral 0-1 (num√©rico, escalado)</li>
          <li>üí∞ <strong>salario:</strong> Salario actual (num√©rico, escalado)</li>
          <li>üìö <strong>n_capacitaciones:</strong> N√∫mero de capacitaciones (entero, escalado)</li>
          <li>‚≠ê <strong>eval_desempeno:</strong> Evaluaci√≥n 1-5 (num√©rico, escalado)</li>
        </ul>
        <hr>
        <p class="mb-0 small text-muted"><strong>Preprocesamiento:</strong> Imputaci√≥n de valores faltantes (mediana) y escalado est√°ndar en pipeline.</p>
      </div>
    </div>

    <!-- Card de Matriz de Confusi√≥n -->
    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Matriz de Confusi√≥n</h5>
      </div>
      <div class="card-body text-center">
        {% if cm_img %}
          <img src="{{ url_for('static', filename=cm_img) }}" alt="Matriz de confusi√≥n" class="img-fluid rounded border">
        {% else %}
          <div class="alert alert-warning">
            <p class="mb-0">Matriz de confusi√≥n no disponible. Entrena el modelo primero.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Columna derecha: Reporte y Formulario -->
  <div class="col-md-8">
    <!-- Card de Reporte de Clasificaci√≥n -->
    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Reporte de Clasificaci√≥n</h5>
      </div>
      <div class="card-body">
        {% if report %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Clase</th>
                  <th>Precision</th>
                  <th>Recall</th>
                  <th>F1-score</th>
                  <th>Support</th>
                </tr>
              </thead>
              <tbody>
                {% for cls, vals in report.items() %}
                  {% if cls in ['Baja','Alta'] %}
                  <tr>
                    <td><strong>{{ cls }}</strong></td>
                    <td>{{ "%.4f"|format(vals.precision) }}</td>
                    <td>{{ "%.4f"|format(vals.recall) }}</td>
                    <td>{{ "%.4f"|format(vals['f1-score']) }}</td>
                    <td>{{ vals.support }}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if 'accuracy' in report %}
          <div class="mt-2">
            <p class="mb-1"><strong>Accuracy general:</strong> {{ "%.4f"|format(report.accuracy) }}</p>
            <p class="mb-1"><strong>Macro avg F1:</strong> {{ "%.4f"|format(report['macro avg']['f1-score']) }}</p>
            <p class="mb-0"><strong>Weighted avg F1:</strong> {{ "%.4f"|format(report['weighted avg']['f1-score']) }}</p>
          </div>
          {% endif %}
        {% else %}
          <div class="alert alert-warning">
            <p class="mb-0">Reporte no disponible. Entrena el modelo primero.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Card de Formulario de Predicci√≥n -->
    <div class="card mb-3 border-warning">
      <div class="card-header bg-warning">
        <h5 class="mb-0">üîÆ Formulario de Predicci√≥n</h5>
      </div>
      <div class="card-body">
        <form id="predict-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">A√±os en la empresa</label>
              <input type="number" step="0.1" min="0" max="40" class="form-control" name="anios_empresa" placeholder="Ej: 3.5" required>
              <small class="text-muted">Rango: 0 - 40 a√±os</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Nivel de satisfacci√≥n</label>
              <input type="number" step="0.01" min="0" max="1" class="form-control" name="nivel_satisfaccion" placeholder="Ej: 0.75" required>
              <small class="text-muted">Rango: 0.00 - 1.00</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Salario</label>
              <input type="number" step="0.01" min="0" class="form-control" name="salario" placeholder="Ej: 3500" required>
              <small class="text-muted">En unidades locales</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">N√∫mero de capacitaciones</label>
              <input type="number" step="1" min="0" class="form-control" name="n_capacitaciones" placeholder="Ej: 2" required>
              <small class="text-muted">Entero positivo</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Evaluaci√≥n de desempe√±o</label>
              <input type="number" step="0.1" min="1" max="5" class="form-control" name="eval_desempeno" placeholder="Ej: 3.8" required>
              <small class="text-muted">Escala: 1 - 5</small>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-bold">Umbral (threshold)</label>
              <input type="number" step="0