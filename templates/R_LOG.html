<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .prediction-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .prediction-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Peque√±as mejoras manteniendo el estilo original */
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .form-control.is-valid {
            border-color: #28a745;
        }
        .invalid-feedback {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">{{ title }}</h2>

        <div class="card mb-4">
            <div class="card-header">
                Descripci√≥n del Modelo
            </div>
            <div class="card-body">
                <p>Este modelo de regresi√≥n log√≠stica predice la probabilidad de que un trabajador sufra un accidente laboral, bas√°ndose en variables como horas trabajadas, nivel de seguridad en su puesto, edad y tiempo en el puesto.</p>
                <p><strong>Interpretaci√≥n:</strong></p>
                <ul>
                    <li><strong>"S√≠":</strong> Alta probabilidad de accidente (‚â•50%)</li>
                    <li><strong>"No":</strong> Baja probabilidad de accidente (&lt;50%)</li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        M√©tricas de Evaluaci√≥n
                    </div>
                    <div class="card-body">
                        <h4>Exactitud (Accuracy): 
                            <span class="badge bg-primary">{{ "%.2f"|format(accuracy*100) }}%</span>
                        </h4>
                        <hr>
                        <h5>Reporte de Clasificaci√≥n</h5>
                        <div class="table-responsive">
                            {{ report|safe }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        Matriz de Confusi√≥n
                    </div>
                    <div class="card-body text-center">
                        {% if cm_img %}
                            <img src="data:image/png;base64,{{ cm_img }}" alt="Matriz de Confusi√≥n" class="img-fluid">
                        {% else %}
                            <p class="text-muted">Matriz de confusi√≥n no disponible</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                Formulario de Predicci√≥n
            </div>
            <div class="card-body">
                <form id="prediction-form" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horas_trabajadas" class="form-label">
                                    Horas trabajadas <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       step="0.5" 
                                       min="1" 
                                       max="16" 
                                       class="form-control" 
                                       id="horas_trabajadas" 
                                       name="horas_trabajadas" 
                                       required
                                       placeholder="Ej: 8">
                                <div class="form-text">Horas trabajadas por d√≠a (1-16)</div>
                                <div class="invalid-feedback">Por favor ingrese las horas trabajadas v√°lidas (1-16).</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edad" class="form-label">
                                    Edad <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       min="18" 
                                       max="65" 
                                       class="form-control" 
                                       id="edad" 
                                       name="edad" 
                                       required
                                       placeholder="Ej: 30">
                                <div class="form-text">Edad del trabajador (18-65 a√±os)</div>
                                <div class="invalid-feedback">Por favor ingrese una edad v√°lida (18-65 a√±os).</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nivel_seguridad" class="form-label">
                                    Nivel de seguridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="nivel_seguridad" name="nivel_seguridad" required>
                                    <option value="">Selecciona un nivel</option>
                                    <option value="Alto">Alto - M√°ximas medidas de seguridad</option>
                                    <option value="Medio">Medio - Medidas de seguridad est√°ndar</option>
                                    <option value="Bajo">Bajo - Medidas de seguridad m√≠nimas</option>
                                </select>
                                <div class="form-text">Nivel de medidas de seguridad en el puesto</div>
                                <div class="invalid-feedback">Por favor seleccione un nivel de seguridad.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tiempo_puesto" class="form-label">
                                    Tiempo en el puesto <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       step="0.1" 
                                       min="0.1" 
                                       max="20" 
                                       class="form-control" 
                                       id="tiempo_puesto" 
                                       name="tiempo_puesto" 
                                       required
                                       placeholder="Ej: 2.5">
                                <div class="form-text">A√±os de experiencia en el puesto actual</div>
                                <div class="invalid-feedback">Por favor ingrese el tiempo en el puesto (m√≠nimo 0.1 a√±os).</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de utilidad -->
                    <div class="d-flex gap-2 mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillExampleData()">
                            Llenar con ejemplo
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearForm()">
                            Limpiar
                        </button>
                    </div>
                    
                    <!-- BOT√ìN PRINCIPAL DE PREDICCI√ìN -->
                    <button type="submit" class="btn btn-success btn-lg w-100" id="predict-btn">
                        <span id="btn-text">üîÆ REALIZAR PREDICCI√ìN</span>
                        <span id="btn-loading" style="display: none;">
                            <span class="loading-spinner"></span> Procesando...
                        </span>
                    </button>
                </form>
                
                <!-- √Årea de resultados -->
                <div id="prediction-result-container" style="display: none;">
                    <hr class="my-4">
                    <h4>Resultado de la Predicci√≥n:</h4>
                    <div id="prediction-result"></div>
                </div>
                

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funci√≥n para llenar datos de ejemplo
        function fillExampleData() {
            document.getElementById('horas_trabajadas').value = '10';
            document.getElementById('nivel_seguridad').value = 'Bajo';
            document.getElementById('edad').value = '28';
            document.getElementById('tiempo_puesto').value = '1.5';
            
            // Limpiar validaciones
            clearValidationClasses();
        }
        
        // Funci√≥n para limpiar el formulario
        function clearForm() {
            document.getElementById('prediction-form').reset();
            document.getElementById('prediction-result-container').style.display = 'none';
            clearValidationClasses();
        }
        
        // Funci√≥n para limpiar clases de validaci√≥n
        function clearValidationClasses() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.is-valid').forEach(el => el.classList.remove('is-valid'));
            document.getElementById('prediction-form').classList.remove('was-validated');
        }
        
        // Validaci√≥n de campo individual
        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            
            if (field.hasAttribute('required') && !value) {
                isValid = false;
            } else if (value) {
                // Validaciones espec√≠ficas por campo
                if (field.id === 'horas_trabajadas') {
                    const hours = parseFloat(value);
                    isValid = !isNaN(hours) && hours >= 1 && hours <= 16;
                } else if (field.id === 'edad') {
                    const age = parseInt(value);
                    isValid = !isNaN(age) && age >= 18 && age <= 65;
                } else if (field.id === 'tiempo_puesto') {
                    const time = parseFloat(value);
                    isValid = !isNaN(time) && time >= 0.1;
                }
            }
            
            // Aplicar clases de validaci√≥n
            if (isValid && value) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else if (!isValid) {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
            }
            
            return isValid;
        }
        
        // Configurar validaci√≥n en tiempo real
        function setupValidation() {
            const inputs = document.querySelectorAll('#prediction-form input, #prediction-form select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });
            });
        }
        
        // Funci√≥n principal del formulario
        document.getElementById('prediction-form').addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();

            const formData = new FormData(this);
            const predictBtn = document.getElementById('predict-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');
            
            // Validar formulario
            let isFormValid = true;
            const inputs = this.querySelectorAll('input[required], select[required]');
            
            inputs.forEach(input => {
                if (!validateField(input)) {
                    isFormValid = false;
                }
            });
            
            this.classList.add('was-validated');
            
            if (!isFormValid) {
                this.classList.add('error-shake');
                setTimeout(() => this.classList.remove('error-shake'), 500);
                showError('Todos los campos son obligatorios y deben tener valores v√°lidos');
                return;
            }
            
            // Cambiar estado del bot√≥n
            predictBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            
            // Mostrar √°rea de resultado
            document.getElementById('prediction-result-container').style.display = 'block';
            document.getElementById('prediction-result').innerHTML = 
                '<div class="alert alert-info">‚è≥ Procesando predicci√≥n...</div>';

            // Enviar solicitud
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Resultado:', result);
                
                if (result.error) {
                    showError(result.error);
                } else {
                    showPrediction(result);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error de conexi√≥n con el servidor');
            })
            .finally(() => {
                // Restaurar bot√≥n
                predictBtn.disabled = false;
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
            });
        });
        
        // Mostrar errores
        function showError(message) {
            document.getElementById('prediction-result').innerHTML = 
                `<div class="alert alert-danger">
                    <strong>‚ùå Error:</strong> ${message}
                </div>`;
        }
        
        // Mostrar resultados (manteniendo el estilo original)
        function showPrediction(result) {
            const isHighRisk = result.prediction === 'S√≠';
            const alertClass = isHighRisk ? 'prediction-danger' : 'prediction-success';
            const icon = isHighRisk ? '‚ö†Ô∏è' : '‚úÖ';
            const riskText = isHighRisk ? 'ALTO RIESGO' : 'BAJO RIESGO';
            
            const probabilityPercent = (parseFloat(result.probability) * 100).toFixed(1);
            
            document.getElementById('prediction-result').innerHTML = 
                `<div class="${alertClass}">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3" style="font-size: 3rem;">${icon}</div>
                        <div>
                            <h3 class="alert-heading mb-1">${riskText} DE ACCIDENTE</h3>
                            <p class="mb-0"><strong>Probabilidad: ${probabilityPercent}%</strong></p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row text-center mt-3">
                        <div class="col-3">
                            <small class="text-muted">Horas trabajadas</small>
                            <div><strong>${result.input_data.horas_trabajadas}</strong></div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Edad</small>
                            <div><strong>${result.input_data.edad} a√±os</strong></div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Experiencia</small>
                            <div><strong>${result.input_data.tiempo_puesto} a√±os</strong></div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Seguridad</small>
                            <div><strong>${result.input_data.nivel_seguridad}</strong></div>
                        </div>
                    </div>
                </div>`;
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setupValidation();
        });
    </script>
</body>
</html>